<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflection Coefficient & Impedance Matching Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white { background-color: #2d3748; }
        .dark .text-gray-800 { color: #e2e8f0; }
        .dark .text-gray-700 { color: #a0aec0; }
        .dark .text-gray-600 { color: #718096; }
        .dark .text-gray-500 { color: #a0aec0; }
        .dark .border-gray-300 { border-color: #4a5568; }
        .dark .border-gray-200 { border-color: #4a5568; }
        .dark .bg-gray-50 { background-color: #2d3748; }
        .dark .bg-gray-100 { background-color: #1a202c; }
        .dark .bg-gray-200 { background-color: #4a5568; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); }
        .dark input[type="number"], .dark input[type="text"], .dark select, .dark textarea {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
        .dark .tab-button {
            color: #a0aec0;
        }
        .dark .tab-button.active {
            color: #3b82f6; /* Or a lighter blue for dark mode */
            border-color: #3b82f6;
        }
        .dark .guidance-panel {
            background-color: #2c3748; /* Slightly lighter than main dark bg */
            border-left-color: #60a5fa; /* Lighter blue for accent */
        }
        .dark .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark .modal-close-button { color: #cbd5e0; }
        .dark .modal-close-button:hover { color: #ffffff; }

        .tab-button.active {
            border-bottom-width: 2px;
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .step-content.hidden { display: none; }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .user-calc-feedback.correct { color: #22c55e; } /* Green */
        .user-calc-feedback.incorrect { color: #ef4444; } /* Red */

        /* Ensure LaTeX is visible in dark mode */
        .dark mjx-container { color: #e2e8f0 !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="loader"></div>
        <p class="text-white text-xl ml-4">Calculating...</p>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center">
            <p id="alert-message" class="text-lg mb-4"></p>
            <button id="alert-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center">
            <p id="confirm-message" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Yes</button>
                <button id="confirm-no-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-lg">No</button>
            </div>
        </div>
    </div>
    
    <div id="theory-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4 overflow-y-auto">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-600">Theoretical Background</h2>
                <button id="theory-modal-close-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="theory-modal-content" class="text-sm md:text-base">
                </div>
        </div>
    </div>


    <div class="container mx-auto p-4">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-700">Reflection Coefficient & Impedance Matching Simulator</h1>
            <div class="flex items-center space-x-4">
                <button id="print-btn" title="Print Current View" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a8.518 8.518 0 0 1 3.586 0M6.72 13.829V3.75A2.25 2.25 0 0 1 9 1.5h6A2.25 2.25 0 0 1 17.25 3.75v10.079M6.72 13.829A2.25 2.25 0 0 0 9 16.125h6a2.25 2.25 0 0 0 2.25-2.296V3.75m-10.5 10.079h10.5" />
                    </svg>
                </button>
                <button id="screenshot-btn" title="Take Screenshot" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.174C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.174 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                    </svg>
                </button>
                <button id="voice-toggle-btn" title="Toggle Voice Instructions" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg id="voice-on-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                    </svg>
                    <svg id="voice-off-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6.375a5.625 5.625 0 1 1-11.25 0 5.625 5.625 0 0 1 11.25 0ZM12.75 9.75 10.5 12m0 0 2.25 2.25M10.5 12l2.25-2.25M10.5 12l-2.25 2.25M7.5 15l2.25-2.25M7.5 15l-2.25-2.25M7.5 15l2.25 2.25M7.5 15l-2.25 2.25M15 9.75l2.25-2.25M15 9.75l-2.25-2.25M15 9.75l2.25 2.25M15 9.75l-2.25 2.25" />
                    </svg>
                </button>
                <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                    </div>
                    <div class="ml-3 text-gray-700 dark:text-gray-300 text-sm font-medium">Dark Mode</div>
                </label>
            </div>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="border-b border-gray-300 mb-6">
                <nav class="flex space-x-1 sm:space-x-4" aria-label="Tabs">
                    <button data-tab="simulationTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none active">Simulation</button>
                    <button data-tab="historyTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none">History</button>
                    <button data-tab="analyticsTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none">Analytics</button>
                    <button data-tab="comparisonTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none">Comparison</button>
                </nav>
            </div>

            <div id="simulationTab" class="tab-panel active">
                <div class="guidance-panel bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md mb-6">
                    <h3 id="step-title" class="text-xl font-semibold text-blue-700 mb-1"></h3>
                    <p id="step-instruction" class="text-gray-700"></p>
                </div>

                <div id="step1Content" class="step-content">
                    <p class="mb-4 text-lg">Welcome to the Reflection Coefficient & Impedance Matching Simulator!</p>
                    <p class="mb-3">This tool helps you understand phenomena related to impedance mismatches in transmission lines, such as:</p>
                    <ul class="list-disc list-inside mb-3 ml-4 space-y-1">
                        <li>Reflection Coefficient ($\Gamma$)</li>
                        <li>Voltage Standing Wave Ratio (VSWR)</li>
                        <li>Return Loss (RL)</li>
                        <li>Input Impedance ($Z_{in}$) of a terminated line</li>
                        <li>Standing Wave Patterns</li>
                    </ul>
                    <p class="mb-6">When a transmission line is terminated with an impedance ($Z_L$) that is not equal to its characteristic impedance ($Z_0$), a portion of the incident wave is reflected. This simulator allows you to explore these effects by varying line and load parameters.</p>
                    <button id="start-sim-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Start Simulation</button>
                </div>

                <div id="step2Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Transmission Line & Load Parameters:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="charImpedance" class="block text-sm font-medium text-gray-700">Characteristic Impedance ($Z_0$, Ω):</label>
                            <input type="number" id="charImpedance" value="50" min="1" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="loadImpedanceReal" class="block text-sm font-medium text-gray-700">Load Impedance ($Z_L$) - Real Part (Ω):</label>
                            <input type="number" id="loadImpedanceReal" value="75" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="loadImpedanceImag" class="block text-sm font-medium text-gray-700">Load Impedance ($Z_L$) - Imaginary Part (jΩ):</label>
                            <input type="number" id="loadImpedanceImag" value="25" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="frequency" class="block text-sm font-medium text-gray-700">Frequency (MHz):</label>
                            <input type="number" id="frequency" value="100" min="0.001" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="lineLength" class="block text-sm font-medium text-gray-700">Line Length (m):</label>
                            <input type="number" id="lineLength" value="1.5" min="0.001" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="velocityFactor" class="block text-sm font-medium text-gray-700">Velocity Factor ($v_f$):</label>
                            <input type="number" id="velocityFactor" value="0.66" min="0.01" max="1" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                         <div>
                            <label for="incidentVoltage" class="block text-sm font-medium text-gray-700">Incident Voltage ($V_{inc}$, V peak - for plot):</label>
                            <input type="number" id="incidentVoltage" value="1" min="0.01" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" title="This only scales the standing wave plot, does not affect Gamma, VSWR, RL, Zin.">
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="params-to-review-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Confirm Parameters</button>
                        <button id="load-defaults-params-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Load Defaults</button>
                    </div>
                </div>

                <div id="step3Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Review Entered Data:</h4>
                    <div id="review-data-display" class="space-y-2 p-4 border border-gray-200 rounded-md bg-gray-50 mb-6">
                        </div>
                    <div class="flex space-x-4">
                        <button id="review-to-theory-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Proceed to Theory</button>
                        <button id="review-to-params-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Parameters</button>
                    </div>
                </div>

                <div id="step4Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Theoretical Background:</h4>
                    <div id="theory-display" class="prose dark:prose-invert max-w-none p-4 border border-gray-200 rounded-md bg-gray-50 mb-6">
                        </div>
                    <button id="show-full-theory-modal-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg mb-6">View Detailed Formulas</button>
                    <div class="flex space-x-4">
                        <button id="theory-to-usercalc-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Proceed to Self-Calculation</button>
                        <button id="theory-to-review-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Review</button>
                    </div>
                </div>
                
                <div id="step5Content" class="step-content hidden"> <h4 class="text-xl font-semibold mb-4 text-gray-700">Your Turn: Estimate Results!</h4>
                    <p class="mb-4 text-gray-600">Based on the parameters and theory, try to estimate the following values. This will help reinforce your understanding.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="userGammaMag" class="block text-sm font-medium text-gray-700">Est. Reflection Coeff. $|\Gamma|$:</label>
                            <input type="number" id="userGammaMag" step="0.01" min="0" max="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackGammaMag" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userGammaAngle" class="block text-sm font-medium text-gray-700">Est. Reflection Coeff. Angle (degrees):</label>
                            <input type="number" id="userGammaAngle" step="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackGammaAngle" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userVSWR" class="block text-sm font-medium text-gray-700">Est. VSWR:</label>
                            <input type="number" id="userVSWR" step="0.1" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackVSWR" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userReturnLoss" class="block text-sm font-medium text-gray-700">Est. Return Loss (dB):</label>
                            <input type="number" id="userReturnLoss" step="0.1" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackReturnLoss" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                    </div>
                    <div class="flex space-x-4 mt-4">
                        <button id="check-user-calc-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg">Check My Estimates</button>
                        <button id="usercalc-to-results-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">View Simulation Results</button>
                        <button id="usercalc-to-theory-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Theory</button>
                    </div>
                </div>

                <div id="step6Content" class="step-content hidden"> <h4 class="text-2xl font-bold mb-6 text-gray-800">Simulation Results:</h4>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h5 class="text-lg font-semibold mb-3 text-blue-700">Calculated Parameters:</h5>
                            <p><strong>Wavelength ($\lambda$):</strong> <span id="resultWavelength"></span> m</p>
                            <p><strong>Propagation Constant ($\beta l$):</strong> <span id="resultBetaL"></span> radians (<span id="resultBetaLDeg"></span>°)</p>
                            <p><strong>Reflection Coefficient ($\Gamma$):</strong> <span id="resultGamma"></span></p>
                            <p><strong>&nbsp;&nbsp;&nbsp;&nbsp;$|\Gamma|$:</strong> <span id="resultGammaMag"></span></p>
                            <p><strong>&nbsp;&nbsp;&nbsp;&nbsp;Angle($\Gamma$):</strong> <span id="resultGammaAngle"></span>°</p>
                            <p class="font-bold text-green-600"><strong>VSWR:</strong> <span id="resultVSWR"></span></p>
                            <p class="font-bold text-green-600"><strong>Return Loss (RL):</strong> <span id="resultRL"></span> dB</p>
                            <p><strong>Input Impedance ($Z_{in}$ at $d=l$):</strong> <span id="resultZin"></span> Ω</p>
                        </div>
                        
                        <div class="lg:col-span-1 p-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-800">
                             <h5 class="text-lg font-semibold mb-3 text-blue-700 dark:text-blue-400">Standing Wave Pattern:</h5>
                             <p class="text-xs mb-2 text-gray-600 dark:text-gray-400">Voltage magnitude along the line (distance $d$ from load). $V_{inc} = <span id="plotVinc"></span>V$.</p>
                             <div id="standingWavePlot" class="w-full h-80 md:h-96 bg-gray-200 dark:bg-gray-700 rounded-md flex items-center justify-center text-gray-500 dark:text-gray-400 overflow-hidden">
                                 Plot will appear here.
                             </div>
                        </div>
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <button id="results-to-analysis-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Analyze & Experiment Further</button>
                        <button id="save-results-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Save Experiment</button>
                        <button id="results-to-usercalc-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Self-Calc</button>
                    </div>
                </div>

                <div id="step7Content" class="step-content hidden"> <h4 class="text-xl font-semibold mb-4 text-gray-700">Analysis & Further Experimentation:</h4>
                    <p class="mb-4 text-gray-600">You've completed a simulation run! Consider the following:</p>
                    <ul class="list-disc list-inside mb-6 text-gray-600 space-y-1">
                        <li>How does $Z_L$ relative to $Z_0$ affect $|\Gamma|$ and VSWR? What happens if $Z_L = Z_0$?</li>
                        <li>Observe the standing wave pattern. How do the locations of maxima and minima relate to the wavelength and load impedance?</li>
                        <li>How does the input impedance ($Z_{in}$) change with line length ($l$) for a mismatched load?</li>
                        <li>What is the significance of a high VSWR or a low Return Loss?</li>
                        <li>Experiment with different parameters to observe their effects. Use the "Run New Experiment" button to go back to the parameter input step.</li>
                        <li>Check the 'Experiment History' and 'Analytics Dashboard' tabs to review past runs and identify trends.</li>
                    </ul>
                    <div class="flex flex-wrap gap-4">
                        <button id="analysis-to-params-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Run New Experiment</button>
                        <button onclick="document.querySelector('[data-tab=\'historyTab\']').click()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg">View Experiment History</button>
                        <button onclick="document.querySelector('[data-tab=\'analyticsTab\']').click()" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg">Open Analytics Dashboard</button>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-200 flex justify-center">
                    <button id="reset-simulation-flow-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Reset Entire Simulation Flow</button>
                </div>

            </div>

            <div id="historyTab" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Experiment History</h2>
                <div class="mb-4 flex flex-col sm:flex-row gap-2">
                    <input type="text" id="historyNoteInput" placeholder="Add a note for the current experiment before saving..." class="flex-grow p-2 border border-gray-300 rounded-md">
                    <button id="saveCurrentConfigWithNoteBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md whitespace-nowrap">Save Current with Note</button>
                </div>
                <div class="mb-4 flex flex-wrap gap-2">
                    <button id="exportCsvBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">Export to CSV</button>
                    <button id="clearHistoryBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md">Clear All History</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="historyTable" class="min-w-full bg-white border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">$Z_0$ (Ω)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">$Z_L$ (Ω)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Freq (MHz)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Length (m)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">$|\Gamma|$</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VSWR</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RL (dB)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">$Z_{in}$ (Ω)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compare</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                 <p id="no-history-msg" class="text-gray-500 mt-4 hidden">No experiments saved yet.</p>
            </div>

            <div id="analyticsTab" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Analytics Dashboard</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">VSWR vs. Load Resistance (for $X_L=0$)</h3>
                        <div id="vswrVsLoadRChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">Return Loss vs. $|\Gamma|$</h3>
                        <div id="rlVsGammaChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">$|Z_{in}|$ vs. Line Length (normalized to $\lambda$)</h3>
                        <div id="zinVsLengthChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">VSWR Distribution</h3>
                        <div id="vswrDistributionChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                </div>
                <div id="personalizedFeedbackPanel" class="mt-8 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-md hidden">
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">Personalized Feedback</h3>
                    <p id="personalizedFeedbackText" class="text-gray-700"></p>
                </div>
                 <p id="no-analytics-msg" class="text-gray-500 mt-4 hidden">Run some experiments and save them to see analytics.</p>
            </div>

            <div id="comparisonTab" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Experiment Comparison</h2>
                <p class="text-gray-600 mb-6">Select up to 3 experiments from the 'Experiment History' tab (using the 'Compare' checkbox) to see a side-by-side comparison here.</p>
                <div id="comparisonContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                <p id="no-comparison-msg" class="text-gray-500 mt-4 hidden">No experiments selected for comparison, or less than 2 experiments selected.</p>
            </div>
        </div>
    </div>

    <script>
        // --- Global State and Configuration ---
        let currentStep = 1;
        let experimentHistory = [];
        let experimentIdCounter = 0;
        let currentSimulationData = {}; 
        let currentSimulationResults = {}; 
        let isDarkMode = false;
        let isVoiceEnabled = false;
        const MAX_COMPARISON_ITEMS = 3;
        const C0 = 299792458; // Speed of light in m/s

        // --- DOM Element References ---
        const stepTitleEl = document.getElementById('step-title');
        const stepInstructionEl = document.getElementById('step-instruction');
        const stepContents = { // 7 Steps for this simulator
            1: document.getElementById('step1Content'),
            2: document.getElementById('step2Content'),
            3: document.getElementById('step3Content'),
            4: document.getElementById('step4Content'),
            5: document.getElementById('step5Content'), // Self-Calculation
            6: document.getElementById('step6Content'), // Results
            7: document.getElementById('step7Content'), // Analysis
        };
        // Input fields
        const charImpedanceIn = document.getElementById('charImpedance');
        const loadImpedanceRealIn = document.getElementById('loadImpedanceReal');
        const loadImpedanceImagIn = document.getElementById('loadImpedanceImag');
        const frequencyIn = document.getElementById('frequency'); // MHz
        const lineLengthIn = document.getElementById('lineLength'); // m
        const velocityFactorIn = document.getElementById('velocityFactor');
        const incidentVoltageIn = document.getElementById('incidentVoltage');


        // User calculation inputs
        const userGammaMagIn = document.getElementById('userGammaMag');
        const userGammaAngleIn = document.getElementById('userGammaAngle');
        const userVSWRIn = document.getElementById('userVSWR');
        const userReturnLossIn = document.getElementById('userReturnLoss');
        const userCalcFeedbacks = {
            GammaMag: document.getElementById('feedbackGammaMag'), GammaAngle: document.getElementById('feedbackGammaAngle'),
            VSWR: document.getElementById('feedbackVSWR'), RL: document.getElementById('feedbackReturnLoss'),
        };

        // Result display elements
        const resultWavelengthEl = document.getElementById('resultWavelength');
        const resultBetaLEl = document.getElementById('resultBetaL');
        const resultBetaLDegEl = document.getElementById('resultBetaLDeg');
        const resultGammaEl = document.getElementById('resultGamma');
        const resultGammaMagEl = document.getElementById('resultGammaMag');
        const resultGammaAngleEl = document.getElementById('resultGammaAngle');
        const resultVSWREl = document.getElementById('resultVSWR');
        const resultRLEl = document.getElementById('resultRL');
        const resultZinEl = document.getElementById('resultZin');
        const standingWavePlotDiv = document.getElementById('standingWavePlot');
        const plotVincEl = document.getElementById('plotVinc');


        // History tab elements
        const historyTableBodyEl = document.getElementById('historyTableBody');
        const historyNoteInputEl = document.getElementById('historyNoteInput');
        const noHistoryMsgEl = document.getElementById('no-history-msg');

        // Analytics tab elements
        const vswrVsLoadRChartDiv = document.getElementById('vswrVsLoadRChart');
        const rlVsGammaChartDiv = document.getElementById('rlVsGammaChart');
        const zinVsLengthChartDiv = document.getElementById('zinVsLengthChart');
        const vswrDistributionChartDiv = document.getElementById('vswrDistributionChart');
        const personalizedFeedbackPanelEl = document.getElementById('personalizedFeedbackPanel');
        const personalizedFeedbackTextEl = document.getElementById('personalizedFeedbackText');
        const noAnalyticsMsgEl = document.getElementById('no-analytics-msg');

        // Comparison tab elements
        const comparisonContainerEl = document.getElementById('comparisonContainer');
        const noComparisonMsgEl = document.getElementById('no-comparison-msg');
        
        // Modals
        const loadingOverlay = document.getElementById('loading-overlay');
        const alertModal = document.getElementById('alert-modal');
        const alertMessageEl = document.getElementById('alert-message');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const theoryModal = document.getElementById('theory-modal');
        const theoryModalContentEl = document.getElementById('theory-modal-content');

        // --- Complex Number Class (from original, still useful) ---
        class Complex {
            constructor(real, imag) {
                this.real = real || 0;
                this.imag = imag || 0;
            }
            add(other) { return new Complex(this.real + other.real, this.imag + other.imag); }
            subtract(other) { return new Complex(this.real - other.real, this.imag - other.imag); }
            multiply(other) { return new Complex(this.real * other.real - this.imag * other.imag, this.real * other.imag + this.imag * other.real); }
            divide(other) {
                const denominator = other.real * other.real + other.imag * other.imag;
                if (denominator === 0) { showCustomAlert("Error: Division by zero in complex numbers."); return new Complex(Infinity, Infinity); }
                const numerator = this.multiply(other.conjugate());
                return new Complex(numerator.real / denominator, numerator.imag / denominator);
            }
            conjugate() { return new Complex(this.real, -this.imag); }
            magnitude() { return Math.sqrt(this.real * this.real + this.imag * this.imag); }
            angleRad() { return Math.atan2(this.imag, this.real); }
            angleDeg() { return this.angleRad() * 180 / Math.PI; }
            exp() { const expReal = Math.exp(this.real); return new Complex(expReal * Math.cos(this.imag), expReal * Math.sin(this.imag)); }
            toString(precision = 4) {
                const r = this.real.toFixed(precision);
                const i = Math.abs(this.imag).toFixed(precision);
                if (this.imag === 0) return r;
                if (this.real === 0) return (this.imag < 0 ? "-" : "") + "j" + i;
                return `${r} ${this.imag < 0 ? "-" : "+"} j${i}`;
            }
            static fromPolarDeg(magnitude, angleDeg) {
                const angleRad = angleDeg * Math.PI / 180;
                return new Complex(magnitude * Math.cos(angleRad), magnitude * Math.sin(angleRad));
            }
        }

        // --- Utility Functions ---
        function showLoadingOverlay() { loadingOverlay.classList.remove('hidden'); }
        function hideLoadingOverlay() { loadingOverlay.classList.add('hidden'); }
        function showCustomAlert(message) { alertMessageEl.textContent = message; alertModal.classList.remove('hidden'); speakMessage(message); }
        function showCustomConfirm(message, onConfirm) {
            confirmMessageEl.textContent = message; confirmModal.classList.remove('hidden');
            speakMessage(message + " Please confirm.");
            document.getElementById('confirm-yes-btn').onclick = () => { confirmModal.classList.add('hidden'); onConfirm(); };
        }
        function speakMessage(text) {
            if (!isVoiceEnabled || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); speechSynthesis.speak(utterance);
        }
        function toggleVoiceInstructions() {
            isVoiceEnabled = !isVoiceEnabled;
            const voiceOnIcon = document.getElementById('voice-on-icon'); const voiceOffIcon = document.getElementById('voice-off-icon');
            if (isVoiceEnabled) { voiceOnIcon.classList.remove('hidden'); voiceOffIcon.classList.add('hidden'); speakMessage("Voice instructions enabled."); } 
            else { voiceOnIcon.classList.add('hidden'); voiceOffIcon.classList.remove('hidden'); speechSynthesis.cancel(); }
            localStorage.setItem('reflectionSimVoiceEnabled', isVoiceEnabled);
        }

        // --- Tab Navigation ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
                document.getElementById(button.dataset.tab).classList.remove('hidden');
                
                if (button.dataset.tab === 'analyticsTab') { 
                    if (experimentHistory.length > 0) {
                        setTimeout(renderAnalyticsCharts, 50); 
                    } else {
                        updateAnalyticsAvailability(); 
                    }
                }
                if (button.dataset.tab === 'simulationTab' && currentStep === 6 && currentSimulationResults.Gamma) { 
                    setTimeout(() => renderStandingWavePattern(currentSimulationResults), 50); 
                }
                speakMessage(`Switched to ${button.textContent} tab.`);
            });
        });

        // --- Step-by-Step Simulation Flow ---
        const stepDetails = { // 7 steps for this simulator
            1: { title: "Welcome & Introduction", instruction: "Understand impedance mismatch, reflections, and related concepts." },
            2: { title: "Step 1: Line & Load Parameters", instruction: "Enter characteristic impedance, load impedance, frequency, line length, and velocity factor." },
            3: { title: "Step 2: Review Entered Parameters", instruction: "Verify the parameters you've selected." },
            4: { title: "Step 3: Theoretical Background", instruction: "Learn about the formulas for reflection coefficient, VSWR, etc." },
            5: { title: "Step 4: Self-Calculation (Optional)", instruction: "Estimate key values before viewing the simulation results." },
            6: { title: "Step 5: Simulation Results & Plot", instruction: "View calculated parameters and the standing wave pattern." },
            7: { title: "Step 6: Analysis & Further Experimentation", instruction: "Reflect on the results and consider further experiments." }
        };

        function updateStepUI() {
            for (const step in stepContents) { stepContents[step].classList.add('hidden'); }
            stepContents[currentStep].classList.remove('hidden');
            stepTitleEl.textContent = stepDetails[currentStep].title;
            stepInstructionEl.textContent = stepDetails[currentStep].instruction;
            speakMessage(stepDetails[currentStep].title + ". " + stepDetails[currentStep].instruction);
            window.scrollTo(0,0); 
        }
        
        function nextStep() { if (currentStep < 7) currentStep++; updateStepUI(); } // Max 7 steps
        function prevStep() { if (currentStep > 1) currentStep--; updateStepUI(); }
        function goToStep(step) { currentStep = step; updateStepUI(); }

        // --- Input Handling and Default Values ---
        function loadDefaultParameters() {
            charImpedanceIn.value = "50";
            loadImpedanceRealIn.value = "75";
            loadImpedanceImagIn.value = "25";
            frequencyIn.value = "100"; // MHz
            lineLengthIn.value = "1.5"; // m
            velocityFactorIn.value = "0.66";
            incidentVoltageIn.value = "1";
            speakMessage("Default parameters loaded.");
        }

        function getSimulationParameters() {
            currentSimulationData = {
                Z0: parseFloat(charImpedanceIn.value),
                ZL_real: parseFloat(loadImpedanceRealIn.value),
                ZL_imag: parseFloat(loadImpedanceImagIn.value),
                frequency_MHz: parseFloat(frequencyIn.value),
                lineLength_m: parseFloat(lineLengthIn.value),
                velocityFactor: parseFloat(velocityFactorIn.value),
                incidentVoltage_V: parseFloat(incidentVoltageIn.value)
            };
            
            const params = currentSimulationData;
            if (isNaN(params.Z0) || params.Z0 <= 0) { showCustomAlert("Characteristic Impedance (Z0) must be a positive number."); return null; }
            if (isNaN(params.ZL_real)) { showCustomAlert("Load Impedance (Real Part) must be a number."); return null; }
            if (isNaN(params.ZL_imag)) { showCustomAlert("Load Impedance (Imaginary Part) must be a number."); return null; }
            if (isNaN(params.frequency_MHz) || params.frequency_MHz <= 0) { showCustomAlert("Frequency must be a positive number."); return null; }
            if (isNaN(params.lineLength_m) || params.lineLength_m <= 0) { showCustomAlert("Line Length must be a positive number."); return null; }
            if (isNaN(params.velocityFactor) || params.velocityFactor <= 0 || params.velocityFactor > 1) { showCustomAlert("Velocity Factor must be between 0 (exclusive) and 1 (inclusive)."); return null; }
            if (isNaN(params.incidentVoltage_V) || params.incidentVoltage_V <= 0) { showCustomAlert("Incident Voltage must be a positive number for plot scaling."); return null; }

            return params;
        }
        
        function displayReviewData(params) {
            const reviewDiv = document.getElementById('review-data-display');
            reviewDiv.innerHTML = `
                <p><strong>Characteristic Impedance ($Z_0$):</strong> ${params.Z0} Ω</p>
                <p><strong>Load Impedance ($Z_L$):</strong> ${params.ZL_real} + j${params.ZL_imag} Ω</p>
                <p><strong>Frequency:</strong> ${params.frequency_MHz} MHz</p>
                <p><strong>Line Length ($l$):</strong> ${params.lineLength_m} m</p>
                <p><strong>Velocity Factor ($v_f$):</strong> ${params.velocityFactor}</p>
                <p><strong>Incident Voltage (for plot):</strong> ${params.incidentVoltage_V} V peak</p>
            `;
        }

        function displayTheory() {
            let theoryHtml = `
                <p class="mb-2">When a transmission line with characteristic impedance $Z_0$ is terminated by a load $Z_L$, reflections occur if $Z_L \\neq Z_0$.</p>
                <h5 class="font-semibold mt-3 mb-1">Reflection Coefficient ($\Gamma$)</h5>
                <p>The ratio of the reflected voltage (or current) wave to the incident voltage (or current) wave at the load:</p>
                <p class="font-mono text-center text-lg my-2">$$ \\Gamma = \\frac{Z_L - Z_0}{Z_L + Z_0} $$</p>
                <p> $\\Gamma$ is generally a complex quantity, having a magnitude ($|\\Gamma|$) and a phase angle ($\phi_\\Gamma$).</p>

                <h5 class="font-semibold mt-3 mb-1">Voltage Standing Wave Ratio (VSWR)</h5>
                <p>A measure of the impedance mismatch. It's the ratio of the maximum voltage to the minimum voltage along the line in the standing wave pattern:</p>
                <p class="font-mono text-center text-lg my-2">$$ VSWR = \\frac{1 + |\\Gamma|}{1 - |\\Gamma|} $$</p>
                <p>VSWR ranges from 1 (perfect match, no reflection) to $\\infty$ (total reflection).</p>

                <h5 class="font-semibold mt-3 mb-1">Return Loss (RL)</h5>
                <p>The amount of power that is lost to the load and does not return as a reflection. It's expressed in dB:</p>
                <p class="font-mono text-center text-lg my-2">$$ RL = -20 \\log_{10} |\\Gamma| \\text{ (dB)} $$</p>
                <p>A higher return loss indicates a better match (less power reflected).</p>

                <h5 class="font-semibold mt-3 mb-1">Propagation Constant ($\beta$) and Wavelength ($\lambda$)</h5>
                <p>The phase constant $\\beta$ depends on the frequency ($f$) and the phase velocity ($v_p$) on the line: $v_p = c \\times v_f$, where $c$ is the speed of light and $v_f$ is the velocity factor.</p>
                <p class="font-mono text-center text-lg my-2">$$ \\lambda = \\frac{v_p}{f} = \\frac{c \\cdot v_f}{f} $$</p>
                <p class="font-mono text-center text-lg my-2">$$ \\beta = \\frac{2\\pi}{\\lambda} $$</p>
                
                <h5 class="font-semibold mt-3 mb-1">Input Impedance ($Z_{in}$)</h5>
                <p>The impedance seen looking into the transmission line of length $l$, terminated by $Z_L$:</p>
                <p class="font-mono text-center text-lg my-2">$$ Z_{in} = Z_0 \\frac{Z_L + jZ_0 \\tan(\\beta l)}{Z_0 + jZ_L \\tan(\\beta l)} $$</p>
                <p>Here, $l$ is the length of the line from the input to the load.</p>

                <h5 class="font-semibold mt-3 mb-1">Standing Wave Voltage</h5>
                <p>The magnitude of the total voltage at a distance $d$ from the load (towards the generator) is given by ($V_{inc}$ is peak incident voltage):</p>
                <p class="font-mono text-center text-lg my-2">$$ |V(d)| = |V_{inc} (e^{j\\beta d} + \\Gamma e^{-j\\beta d})| = |V_{inc}| \\cdot |1 + \\Gamma e^{-j2\\beta d}| $$</p>
                 <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Note: The equations here represent common forms. $d$ is often measured from the load towards the generator.</p>
            `;
            document.getElementById('theory-display').innerHTML = theoryHtml;
            theoryModalContentEl.innerHTML = theoryHtml;
            if (window.MathJax) {
                window.MathJax.typesetPromise([document.getElementById('theory-display'), theoryModalContentEl]);
            }
        }
        
        // --- Calculation Logic ---
        function calculateReflectionParameters(params) {
            const Z0 = new Complex(params.Z0, 0);
            const ZL = new Complex(params.ZL_real, params.ZL_imag);
            const freq_Hz = params.frequency_MHz * 1e6;
            const l_m = params.lineLength_m;
            const vf = params.velocityFactor;
            const Vinc_peak = params.incidentVoltage_V;

            // Gamma
            const Gamma = ZL.subtract(Z0).divide(ZL.add(Z0));
            const Gamma_mag = Gamma.magnitude();
            const Gamma_angle_deg = Gamma.angleDeg();

            // VSWR
            let vswr = Infinity;
            if (Gamma_mag < 1) { // Avoid division by zero if |Gamma| = 1
                vswr = (1 + Gamma_mag) / (1 - Gamma_mag);
            }
            
            // Return Loss
            let returnLoss_dB = 0; // Infinite loss if Gamma_mag is 0
            if (Gamma_mag > 0 && Gamma_mag < 1) { // Avoid log(0) and handle Gamma_mag >= 1
                returnLoss_dB = -20 * Math.log10(Gamma_mag);
            } else if (Gamma_mag === 0) {
                returnLoss_dB = Infinity; // Practically very high for Gamma_mag = 0
            } else { // Gamma_mag >= 1 (should not happen for passive loads)
                 returnLoss_dB = -Infinity; // Or handle as error
            }


            // Wavelength and Beta
            const vp = C0 * vf; // Phase velocity
            const lambda_m = vp / freq_Hz;
            const beta = (2 * Math.PI) / lambda_m; // radians/m
            const beta_l_rad = beta * l_m;
            const beta_l_deg = beta_l_rad * 180 / Math.PI;
            
            // Input Impedance (Zin)
            const tan_beta_l = Math.tan(beta_l_rad);
            const j_Z0_tan_beta_l = new Complex(0, Z0.real * tan_beta_l); 
            const j_ZL_tan_beta_l = ZL.multiply(new Complex(0, tan_beta_l));

            const Zin_numerator = ZL.add(j_Z0_tan_beta_l);
            const Zin_denominator = Z0.add(j_ZL_tan_beta_l);

            let Zin;
            if (Zin_denominator.magnitude() < 1e-9) { // Avoid division by zero if denominator is effectively zero
                Zin = new Complex(Infinity, Infinity); // Represents very high impedance
                showCustomAlert("Warning: Input impedance denominator is near zero, Zin is very large (potentially open circuit condition).");
            } else {
                Zin = Z0.multiply(Zin_numerator.divide(Zin_denominator));
            }


            return {
                Gamma, Gamma_mag, Gamma_angle_deg,
                vswr, returnLoss_dB,
                lambda_m, beta_l_rad, beta_l_deg,
                Zin,
                Vinc_peak // Pass through for plot
            };
        }

        function runSimulation() {
            const params = getSimulationParameters();
            if (!params) return null;

            showLoadingOverlay();
            return new Promise(resolve => {
                setTimeout(() => {
                    const results = calculateReflectionParameters(params);
                    currentSimulationResults = { ...params, ...results }; // Store everything
                    hideLoadingOverlay();
                    resolve(currentSimulationResults);
                }, 200); 
            });
        }

        // --- User Self-Calculation ---
        function checkUserCalculations() {
            if (!currentSimulationResults || !currentSimulationResults.Gamma) {
                showCustomAlert("Please run a simulation first to get actual values.");
                return;
            }
            let allCorrect = true;
            const tolerance = 0.05; // 5% tolerance
            const angleToleranceDeg = 5; // 5 degrees absolute for angles

            function checkValue(userInputEl, actualValue, feedbackEl, paramName, isAngle = false) {
                const userVal = parseFloat(userInputEl.value);
                if (isNaN(userVal)) {
                    feedbackEl.textContent = "Enter a number."; feedbackEl.className = "user-calc-feedback incorrect"; allCorrect = false; return;
                }
                
                let isWithinTolerance = false;
                if (isAngle) {
                    let angleDiff = Math.abs(userVal - actualValue);
                    while (angleDiff > 180) angleDiff = Math.abs(angleDiff - 360); // Normalize diff to <= 180
                    isWithinTolerance = angleDiff <= angleToleranceDeg;
                } else if (Math.abs(actualValue) < 1e-9) { // Actual is near zero
                    isWithinTolerance = Math.abs(userVal) < 1e-3; // User value also needs to be near zero
                } else if (!isFinite(actualValue)) { // Actual is Infinity
                     isWithinTolerance = !isFinite(userVal) || Math.abs(userVal) > 1e6; // User value also very large or infinity
                } else { // Standard relative tolerance
                     isWithinTolerance = Math.abs(userVal - actualValue) / Math.abs(actualValue) <= tolerance;
                }

                if (isWithinTolerance) {
                    feedbackEl.textContent = `Correct! (Actual: ${isFinite(actualValue) ? actualValue.toFixed(3) : actualValue.toString()})`;
                    feedbackEl.className = "user-calc-feedback correct";
                } else {
                    feedbackEl.textContent = `Incorrect. (Actual: ${isFinite(actualValue) ? actualValue.toFixed(3) : actualValue.toString()})`;
                    feedbackEl.className = "user-calc-feedback incorrect";
                    allCorrect = false;
                }
            }
            
            checkValue(userGammaMagIn, currentSimulationResults.Gamma_mag, userCalcFeedbacks.GammaMag, "|Γ|");
            checkValue(userGammaAngleIn, currentSimulationResults.Gamma_angle_deg, userCalcFeedbacks.GammaAngle, "Angle(Γ)", true);
            checkValue(userVSWRIn, currentSimulationResults.vswr, userCalcFeedbacks.VSWR, "VSWR");
            checkValue(userReturnLossIn, currentSimulationResults.returnLoss_dB, userCalcFeedbacks.RL, "RL (dB)");

            if (allCorrect) { speakMessage("Excellent! All your estimates are within tolerance."); } 
            else { speakMessage("Some estimates need adjustment. Check the feedback."); }
        }
        
        function clearUserCalcFeedback() {
            Object.values(userCalcFeedbacks).forEach(el => { el.textContent = ''; el.className = 'user-calc-feedback text-sm mt-1'; });
            [userGammaMagIn, userGammaAngleIn, userVSWRIn, userReturnLossIn].forEach(input => input.value = '');
        }

        // --- Display Results ---
        function displayResults(results) {
            resultWavelengthEl.textContent = results.lambda_m.toFixed(4);
            resultBetaLEl.textContent = results.beta_l_rad.toFixed(4);
            resultBetaLDegEl.textContent = results.beta_l_deg.toFixed(2);
            resultGammaEl.textContent = results.Gamma.toString(4);
            resultGammaMagEl.textContent = results.Gamma_mag.toFixed(4);
            resultGammaAngleEl.textContent = results.Gamma_angle_deg.toFixed(2);
            resultVSWREl.textContent = isFinite(results.vswr) ? results.vswr.toFixed(3) : "Infinity";
            resultRLEl.textContent = isFinite(results.returnLoss_dB) ? results.returnLoss_dB.toFixed(2) : (results.returnLoss_dB === Infinity ? "Infinity (Perfect Match)" : "Invalid (Check Gamma)");
            resultZinEl.textContent = isFinite(results.Zin.real) && isFinite(results.Zin.imag) ? results.Zin.toString(3) : "Infinity (or near Open/Short)";
            plotVincEl.textContent = results.Vinc_peak.toFixed(2);
            
            renderStandingWavePattern(results);
        }
        
        function renderStandingWavePattern(results) {
            if (!results.Gamma || typeof results.lineLength_m === 'undefined') {
                standingWavePlotDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Plot data not available.</p>';
                return;
            }
            try {
                Plotly.purge(standingWavePlotDiv); 
                standingWavePlotDiv.innerHTML = ''; // Clear placeholder

                const l = results.lineLength_m;
                const beta = (2 * Math.PI) / results.lambda_m;
                const Gamma = results.Gamma; // Complex Gamma
                const Vinc_peak = results.Vinc_peak;

                const numPoints = 200;
                const d_values = []; // distance from load
                const V_mag_values = [];

                for (let i = 0; i <= numPoints; i++) {
                    const d = (i / numPoints) * l; 
                    d_values.push(d);
                    
                    const exp_jbeta_d = (new Complex(0, beta * d)).exp();
                    const exp_neg_jbeta_d = (new Complex(0, -beta * d)).exp();
                    
                    const totalVoltagePhasor = exp_jbeta_d.add(Gamma.multiply(exp_neg_jbeta_d));
                    V_mag_values.push(Vinc_peak * totalVoltagePhasor.magnitude());
                }

                const plotData = [{
                    x: d_values,
                    y: V_mag_values,
                    type: 'scatter',
                    mode: 'lines',
                    name: '$|V(d)|$',
                    line: { color: 'blue', width: 2 }
                }];
                
                const layout = {
                    title: 'Voltage Standing Wave Pattern',
                    xaxis: { title: 'Distance from Load (d, meters)', zeroline: true, zerolinecolor: isDarkMode ? '#555' : '#ccc', gridcolor: isDarkMode ? '#4A5568' : '#ddd' },
                    yaxis: { title: 'Voltage Magnitude ($|V(d)|$, Volts)', zeroline: true, zerolinecolor: isDarkMode ? '#555' : '#ccc', gridcolor: isDarkMode ? '#4A5568' : '#ddd', rangemode: 'tozero'},
                    showlegend: false,
                    width: standingWavePlotDiv.clientWidth > 0 ? standingWavePlotDiv.clientWidth : 500, 
                    height: standingWavePlotDiv.clientHeight > 0 ? standingWavePlotDiv.clientHeight : 400, 
                    paper_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', 
                    plot_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb',  
                    font: { color: isDarkMode ? '#e2e8f0' : '#374151' },
                    margin: { l: 60, r: 30, b: 60, t: 60, pad: 4 },
                    autosize: true
                };
                Plotly.react(standingWavePlotDiv, plotData, layout, {responsive: true});
            } catch (e) {
                console.error("Error rendering standing wave plot:", e);
                standingWavePlotDiv.innerHTML = '<p class="text-red-500">Error rendering plot. Check console.</p>';
            }
        }


        // --- Experiment History ---
        function loadHistory() {
            const storedHistory = localStorage.getItem('reflectionSimHistory');
            if (storedHistory) {
                try {
                    experimentHistory = JSON.parse(storedHistory);
                    if (!Array.isArray(experimentHistory)) experimentHistory = []; 
                    experimentHistory = experimentHistory.filter(e => e && typeof e.id === 'number' && e.params && e.results);
                    experimentIdCounter = experimentHistory.length > 0 ? Math.max(0, ...experimentHistory.map(e => e.id)) : 0;
                } catch (e) { console.error("Error parsing history:", e); experimentHistory = []; experimentIdCounter = 0; }
            }
            renderHistoryTable(); updateAnalyticsAvailability(); updateComparisonAvailability();
        }

        function saveHistory() {
            try { localStorage.setItem('reflectionSimHistory', JSON.stringify(experimentHistory)); } 
            catch (e) { console.error("Error saving history:", e); showCustomAlert("Could not save history."); }
        }

        function addExperimentToHistory(fullResults, note = "") { // fullResults comes from currentSimulationResults
            experimentIdCounter++;
            const newEntry = {
                id: experimentIdCounter,
                timestamp: new Date().toLocaleString(),
                params: { 
                    Z0: fullResults.Z0, 
                    ZL_real: fullResults.ZL_real, ZL_imag: fullResults.ZL_imag,
                    frequency_MHz: fullResults.frequency_MHz, 
                    lineLength_m: fullResults.lineLength_m,
                    velocityFactor: fullResults.velocityFactor,
                    incidentVoltage_V: fullResults.incidentVoltage_V
                }, 
                results: { 
                    Gamma_mag: fullResults.Gamma_mag, Gamma_angle_deg: fullResults.Gamma_angle_deg,
                    vswr: fullResults.vswr, returnLoss_dB: fullResults.returnLoss_dB,
                    Zin_real: fullResults.Zin.real, Zin_imag: fullResults.Zin.imag,
                    lambda_m: fullResults.lambda_m
                },
                fullResultsForDisplay: { // For detailed view if needed later, or comparison.
                    Gamma: fullResults.Gamma.toString(),
                    Zin: (isFinite(fullResults.Zin.real) && isFinite(fullResults.Zin.imag)) ? fullResults.Zin.toString() : "Infinity",
                },
                note: note || historyNoteInputEl.value.trim() || "(No note)"
            };
            experimentHistory.push(newEntry);
            saveHistory(); renderHistoryTable(); updateAnalyticsAvailability(); updateComparisonAvailability();
            historyNoteInputEl.value = ''; speakMessage("Experiment saved to history.");
        }

        function renderHistoryTable() {
            historyTableBodyEl.innerHTML = '';
            if (experimentHistory.length === 0) { noHistoryMsgEl.classList.remove('hidden'); return; }
            noHistoryMsgEl.classList.add('hidden');

            experimentHistory.slice().reverse().forEach(entry => { 
                const row = historyTableBodyEl.insertRow();
                row.insertCell().textContent = entry.id;
                row.insertCell().textContent = entry.timestamp;
                row.insertCell().textContent = entry.params?.Z0?.toFixed(1) || 'N/A';
                row.insertCell().textContent = `${entry.params?.ZL_real?.toFixed(1) || 'N/A'} + j${entry.params?.ZL_imag?.toFixed(1) || 'N/A'}`;
                row.insertCell().textContent = entry.params?.frequency_MHz?.toFixed(2) || 'N/A';
                row.insertCell().textContent = entry.params?.lineLength_m?.toFixed(3) || 'N/A';
                row.insertCell().textContent = entry.results?.Gamma_mag?.toFixed(4) || 'N/A';
                row.insertCell().textContent = isFinite(entry.results?.vswr) ? entry.results.vswr.toFixed(2) : "Inf";
                row.insertCell().textContent = isFinite(entry.results?.returnLoss_dB) ? entry.results.returnLoss_dB.toFixed(2) : (entry.results.returnLoss_dB === Infinity ? "Inf" : "Invalid");
                const zinText = (isFinite(entry.results?.Zin_real) && isFinite(entry.results?.Zin_imag)) 
                                ? `${entry.results.Zin_real.toFixed(1)} + j${entry.results.Zin_imag.toFixed(1)}` 
                                : "Inf";
                row.insertCell().textContent = zinText;
                row.insertCell().textContent = entry.note ? (entry.note.substring(0, 20) + (entry.note.length > 20 ? '...' : '')) : 'N/A';
                
                const actionsCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>`;
                deleteBtn.title = "Delete Entry"; deleteBtn.className = "text-red-500 hover:text-red-700 p-1";
                deleteBtn.onclick = () => deleteHistoryEntry(entry.id); actionsCell.appendChild(deleteBtn);

                const compareCell = row.insertCell();
                const compareCheckbox = document.createElement('input');
                compareCheckbox.type = 'checkbox'; compareCheckbox.className = 'form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500';
                compareCheckbox.dataset.experimentId = entry.id; compareCheckbox.onchange = handleCompareCheckboxChange;
                compareCell.appendChild(compareCheckbox);
            });
        }

        function deleteHistoryEntry(id) {
            showCustomConfirm(`Delete experiment ID ${id}?`, () => {
                experimentHistory = experimentHistory.filter(e => e.id !== id);
                saveHistory(); renderHistoryTable(); updateAnalyticsAvailability(); renderComparisonView(); 
                speakMessage(`Experiment ID ${id} deleted.`);
            });
        }

        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            showCustomConfirm("Clear ALL experiment history?", () => {
                experimentHistory = []; experimentIdCounter = 0; saveHistory(); renderHistoryTable(); 
                updateAnalyticsAvailability(); renderComparisonView(); speakMessage("All history cleared.");
            });
        });
        
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            if (experimentHistory.length === 0) { showCustomAlert("No history to export."); return; }
            const headers = ["ID", "Timestamp", "Z0_ohm", "ZL_real_ohm", "ZL_imag_ohm", "Freq_MHz", "Length_m", "Vf", "V_inc_V", "Gamma_mag", "Gamma_angle_deg", "VSWR", "RL_dB", "Zin_real_ohm", "Zin_imag_ohm", "Lambda_m", "Note"];
            const rows = experimentHistory.map(e => {
                const p = e.params || {}; const r = e.results || {};
                return [
                    e.id, e.timestamp, p.Z0, p.ZL_real, p.ZL_imag, p.frequency_MHz, p.lineLength_m, p.velocityFactor, p.incidentVoltage_V,
                    r.Gamma_mag, r.Gamma_angle_deg, r.vswr, r.returnLoss_dB, r.Zin_real, r.Zin_imag, r.lambda_m,
                    `"${(e.note || '').replace(/"/g, '""')}"` 
                ].join(',');
            });
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "reflection_simulator_history.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            speakMessage("History exported to CSV.");
        });

        // --- Analytics Dashboard ---
        function updateAnalyticsAvailability() {
            if (experimentHistory.length > 0) {
                noAnalyticsMsgEl.classList.add('hidden');
                if (document.getElementById('analyticsTab').classList.contains('active')) {
                    setTimeout(renderAnalyticsCharts, 50); 
                }
            } else {
                noAnalyticsMsgEl.classList.remove('hidden');
                [vswrVsLoadRChartDiv, rlVsGammaChartDiv, zinVsLengthChartDiv, vswrDistributionChartDiv].forEach(div => {
                    if (div) Plotly.purge(div); 
                    if (div) div.innerHTML = '<p class="text-gray-500 dark:text-gray-400 p-4">Chart Area: No data to display.</p>';
                });
                personalizedFeedbackPanelEl.classList.add('hidden');
            }
        }

        function renderAnalyticsCharts() {
            if (experimentHistory.length === 0 || !Plotly || !document.getElementById('analyticsTab').classList.contains('active')) {
                return;
            }
            
            [vswrVsLoadRChartDiv, rlVsGammaChartDiv, zinVsLengthChartDiv, vswrDistributionChartDiv].forEach(div => {
                 if(div) { Plotly.purge(div); div.innerHTML = ''; }
            });

            const commonLayoutProps = (title, xaxis_title, yaxis_title) => ({
                title: {text: title, font: {size: 14}},
                xaxis: {title: xaxis_title, automargin: true, titlefont: {size: 12}, tickfont: {size: 10}, gridcolor: isDarkMode ? '#4A5568' : '#ddd'}, 
                yaxis: {title: yaxis_title, automargin: true, titlefont: {size: 12}, tickfont: {size: 10}, gridcolor: isDarkMode ? '#4A5568' : '#ddd'}, 
                paper_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', plot_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', 
                font: { color: isDarkMode ? '#e2e8f0' : '#374151', size: 10 }, margin: { t:40, l:60, r:30, b:50 },
                autosize: true 
            });
            
            const plotConfig = {responsive: true}; 

            try {
                // Chart 1: VSWR vs. Load Resistance (for XL=0, Z0 fixed if possible)
                const fixedZ0 = experimentHistory.length > 0 && experimentHistory[0].params ? experimentHistory[0].params.Z0 : 50; 
                const vswrRLoadData = experimentHistory
                    .filter(e => e.params && e.results && e.params.ZL_imag === 0 && e.params.Z0 === fixedZ0 && typeof e.params.ZL_real === 'number' && typeof e.results.vswr === 'number' && isFinite(e.results.vswr))
                    .map(e => ({ x: e.params.ZL_real, y: e.results.vswr, text: `ID: ${e.id}<br>Z0: ${e.params.Z0}` }));
                if (vswrRLoadData.length > 1 && vswrVsLoadRChartDiv) {
                     Plotly.react(vswrVsLoadRChartDiv, [{ x: vswrRLoadData.map(d=>d.x), y: vswrRLoadData.map(d=>d.y), mode: 'markers', type: 'scatter', text: vswrRLoadData.map(d=>d.text), hoverinfo: 'text+x+y' }], 
                                  commonLayoutProps(`VSWR vs. Load R (ZL_imag=0, Z0=${fixedZ0}Ω)`, 'Load Resistance (Ω)', 'VSWR'), plotConfig);
                } else if (vswrVsLoadRChartDiv) {
                    vswrVsLoadRChartDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 p-4">Not enough data for VSWR vs Load R chart (needs multiple points with ZL_imag=0 and consistent Z0).</p>';
                }


                // Chart 2: Return Loss vs. |Gamma|
                const rlGammaData = experimentHistory
                    .filter(e => e.results && typeof e.results.Gamma_mag === 'number' && typeof e.results.returnLoss_dB === 'number' && isFinite(e.results.returnLoss_dB))
                    .map(e => ({ x: e.results.Gamma_mag, y: e.results.returnLoss_dB, text: `ID: ${e.id}` }));
                 if (rlGammaData.length > 0 && rlVsGammaChartDiv) {
                    Plotly.react(rlVsGammaChartDiv, [{ x: rlGammaData.map(d=>d.x), y: rlGammaData.map(d=>d.y), mode: 'markers', type: 'scatter', text: rlGammaData.map(d=>d.text), hoverinfo: 'text+x+y' }], 
                                  commonLayoutProps('Return Loss vs. |Γ|', '|Γ| (Reflection Coeff. Mag.)', 'Return Loss (dB)'), plotConfig);
                } else if (rlVsGammaChartDiv) {
                     rlVsGammaChartDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 p-4">No data for RL vs |Γ| chart.</p>';
                }
                
                // Chart 3: |Zin| vs. Line Length (normalized to lambda)
                const zinLengthData = experimentHistory
                    .filter(e => e.params && e.results && typeof e.params.lineLength_m === 'number' && typeof e.results.lambda_m === 'number' && e.results.lambda_m > 0 && typeof e.results.Zin_real === 'number' && typeof e.results.Zin_imag === 'number' && isFinite(e.results.Zin_real) && isFinite(e.results.Zin_imag))
                    .map(e => {
                        const zinMag = new Complex(e.results.Zin_real, e.results.Zin_imag).magnitude();
                        return { x: e.params.lineLength_m / e.results.lambda_m, y: zinMag, text: `ID: ${e.id}<br>ZL: ${e.params.ZL_real}+j${e.params.ZL_imag}`};
                    });
                if (zinLengthData.length > 1 && zinVsLengthChartDiv) {
                    Plotly.react(zinVsLengthChartDiv, [{ x: zinLengthData.map(d=>d.x), y: zinLengthData.map(d=>d.y), mode: 'markers', type: 'scatter', text: zinLengthData.map(d=>d.text), hoverinfo: 'text+x+y' }], 
                                  commonLayoutProps('$|Z_{in}|$ vs. Line Length ($l/\\lambda$)', 'Normalized Line Length ($l/\\lambda$)', '$|Z_{in}|$ (Ω)'), plotConfig);
                } else if (zinVsLengthChartDiv) {
                     zinVsLengthChartDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 p-4">Not enough data for Zin vs Length chart.</p>';
                }


                // Chart 4: VSWR Distribution (Histogram)
                const vswrValues = experimentHistory.map(e => e.results ? e.results.vswr : undefined).filter(v => typeof v === 'number' && isFinite(v));
                if (vswrValues.length > 0 && vswrDistributionChartDiv) {
                     Plotly.react(vswrDistributionChartDiv, [{ x: vswrValues, type: 'histogram' }], 
                                   commonLayoutProps('VSWR Distribution', 'VSWR', 'Frequency (Count)'), plotConfig);
                } else if (vswrDistributionChartDiv) {
                     vswrDistributionChartDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 p-4">No VSWR data for distribution chart.</p>';
                }

            } catch (err) {
                console.error("Error rendering analytics charts:", err);
                [vswrVsLoadRChartDiv, rlVsGammaChartDiv, zinVsLengthChartDiv, vswrDistributionChartDiv].forEach(div => {
                    if(div) div.innerHTML = '<p class="text-red-500 p-4">Error rendering chart. See console.</p>';
                });
            }
            updatePersonalizedFeedback();
        }

        function updatePersonalizedFeedback() {
            if (experimentHistory.length < 3) { personalizedFeedbackPanelEl.classList.add('hidden'); return; }
            const matchedRuns = experimentHistory.filter(e => e.results && e.results.vswr < 1.5 && isFinite(e.results.vswr)).length;
            let feedbackMsg = `You've run ${experimentHistory.length} experiments. `;
            if (matchedRuns > 0) {
                feedbackMsg += `${matchedRuns} of these resulted in a good match (VSWR < 1.5). `;
                const bestMatch = experimentHistory
                    .filter(e => e.results && isFinite(e.results.vswr))
                    .reduce((best, curr) => (curr.results.vswr < best.results.vswr ? curr : best), {results:{vswr:Infinity}}); // Ensure initial best is worst case
                if (bestMatch && bestMatch.results && isFinite(bestMatch.results.vswr) && bestMatch.id) {
                     feedbackMsg += `Your best VSWR so far is ${bestMatch.results.vswr.toFixed(2)} (ID: ${bestMatch.id}).`;
                }
            } else {
                feedbackMsg += "Try adjusting ZL to be closer to Z0 to achieve a better match (lower VSWR).";
            }
            personalizedFeedbackTextEl.textContent = feedbackMsg;
            personalizedFeedbackPanelEl.classList.remove('hidden');
        }

        // --- Comparison View ---
        let selectedForComparison = [];
        function handleCompareCheckboxChange(event) {
            const experimentId = parseInt(event.target.dataset.experimentId);
            if (event.target.checked) {
                if (selectedForComparison.length < MAX_COMPARISON_ITEMS) { selectedForComparison.push(experimentId); } 
                else { event.target.checked = false; showCustomAlert(`Max ${MAX_COMPARISON_ITEMS} experiments for comparison.`); }
            } else { selectedForComparison = selectedForComparison.filter(id => id !== experimentId); }
            renderComparisonView();
        }
        function updateComparisonAvailability() {
             if (selectedForComparison.length >= 1 && selectedForComparison.length <= MAX_COMPARISON_ITEMS) { noComparisonMsgEl.classList.add('hidden'); } 
             else { noComparisonMsgEl.classList.remove('hidden'); comparisonContainerEl.innerHTML = ''; }
        }

        function renderComparisonView() {
            comparisonContainerEl.innerHTML = ''; updateComparisonAvailability();
            if (selectedForComparison.length === 0) return;
            selectedForComparison.forEach(id => {
                const entry = experimentHistory.find(e => e.id === id);
                if (!entry || !entry.params || !entry.results) return; 
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600';
                const zinCompText = (isFinite(entry.results.Zin_real) && isFinite(entry.results.Zin_imag))
                                  ? `${entry.results.Zin_real?.toFixed(1)} + j${entry.results.Zin_imag?.toFixed(1)} Ω`
                                  : "Infinity";
                itemDiv.innerHTML = `
                    <h4 class="text-md font-semibold text-blue-600 dark:text-blue-400 mb-2">ID: ${entry.id}</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">${entry.timestamp || 'N/A'}</p>
                    <p class="text-sm"><strong>$Z_0$:</strong> ${entry.params.Z0?.toFixed(1)} Ω</p>
                    <p class="text-sm"><strong>$Z_L$:</strong> ${entry.params.ZL_real?.toFixed(1)} + j${entry.params.ZL_imag?.toFixed(1)} Ω</p>
                    <p class="text-sm"><strong>Freq:</strong> ${entry.params.frequency_MHz?.toFixed(1)} MHz, <strong>Len:</strong> ${entry.params.lineLength_m?.toFixed(2)} m</p>
                    <hr class="my-2 dark:border-gray-600">
                    <p class="text-sm"><strong>$|\\Gamma|$:</strong> ${entry.results.Gamma_mag?.toFixed(4)}</p>
                    <p class="text-sm"><strong>$\\angle\\Gamma$:</strong> ${entry.results.Gamma_angle_deg?.toFixed(1)}°</p>
                    <p class="text-sm"><strong>VSWR:</strong> ${isFinite(entry.results.vswr) ? entry.results.vswr?.toFixed(2) : "Inf"}</p>
                    <p class="text-sm"><strong>RL:</strong> ${isFinite(entry.results.returnLoss_dB) ? entry.results.returnLoss_dB?.toFixed(2) : (entry.results.returnLoss_dB === Infinity ? "Inf" : "Invalid")} dB</p>
                    <p class="text-sm"><strong>$Z_{in}$:</strong> ${zinCompText}</p>
                    <p class="text-sm mt-1"><strong>Note:</strong> ${entry.note || 'N/A'}</p>
                `;
                comparisonContainerEl.appendChild(itemDiv);
            });
        }

        // --- Event Listeners Setup ---
        document.getElementById('start-sim-btn').addEventListener('click', () => goToStep(2));
        document.getElementById('params-to-review-btn').addEventListener('click', () => {
            const params = getSimulationParameters(); if (params) { displayReviewData(params); goToStep(3); }
        });
        document.getElementById('review-to-params-btn').addEventListener('click', () => goToStep(2));
        document.getElementById('review-to-theory-btn').addEventListener('click', () => {
            displayTheory(); goToStep(4); 
        });
        document.getElementById('theory-to-review-btn').addEventListener('click', () => goToStep(3));
        document.getElementById('theory-to-usercalc-btn').addEventListener('click', async () => { 
            const simData = getSimulationParameters(); if (!simData) return;
            const results = await runSimulation(); 
            if (results) { clearUserCalcFeedback(); goToStep(5); } 
        });
        document.getElementById('usercalc-to-theory-btn').addEventListener('click', () => goToStep(4)); 
        document.getElementById('check-user-calc-btn').addEventListener('click', checkUserCalculations);
        document.getElementById('usercalc-to-results-btn').addEventListener('click', () => { 
            if (currentSimulationResults && currentSimulationResults.Gamma) { displayResults(currentSimulationResults); goToStep(6); } 
            else { showCustomAlert("Run simulation or complete parameter steps first."); }
        });
        document.getElementById('results-to-usercalc-btn').addEventListener('click', () => goToStep(5)); 
        document.getElementById('results-to-analysis-btn').addEventListener('click', () => goToStep(7)); 
        document.getElementById('analysis-to-params-btn').addEventListener('click', () => goToStep(2)); 
        
        document.getElementById('reset-simulation-flow-btn').addEventListener('click', () => {
            showCustomConfirm("Reset simulation? Current inputs will be cleared.", () => {
                loadDefaultParameters(); currentSimulationData = {}; currentSimulationResults = {};
                clearUserCalcFeedback(); goToStep(1); speakMessage("Simulation reset.");
            });
        });
        
        document.getElementById('load-defaults-params-btn').addEventListener('click', loadDefaultParameters);
        document.getElementById('save-results-btn').addEventListener('click', () => {
            if (currentSimulationResults && typeof currentSimulationResults.Gamma !== 'undefined') { addExperimentToHistory(currentSimulationResults); } 
            else { showCustomAlert("No results to save. Run a simulation first."); }
        });
        document.getElementById('saveCurrentConfigWithNoteBtn').addEventListener('click', () => {
             if (currentSimulationResults && typeof currentSimulationResults.Gamma !== 'undefined') { 
                addExperimentToHistory(currentSimulationResults, historyNoteInputEl.value.trim());
            } else if (Object.keys(currentSimulationData).length > 0 && typeof currentSimulationData.Z0 !== 'undefined') { 
                const dummyResults = { 
                    Gamma: new Complex(0,0), Gamma_mag:0, Gamma_angle_deg:0, vswr:1, returnLoss_dB:Infinity, 
                    Zin: new Complex(currentSimulationData.Z0 || 0, 0), lambda_m: 0, Vinc_peak: currentSimulationData.incidentVoltage_V || 1,
                    ...currentSimulationData 
                };
                addExperimentToHistory(dummyResults, historyNoteInputEl.value.trim());
                showCustomAlert("Current parameters saved (without full calculation results). Run simulation for complete data.");
            } else {
                showCustomAlert("No current configuration or results to save.");
            }
        });
        
        document.getElementById('alert-ok-btn').addEventListener('click', () => alertModal.classList.add('hidden'));
        document.getElementById('confirm-no-btn').addEventListener('click', () => confirmModal.classList.add('hidden'));
        document.getElementById('show-full-theory-modal-btn').addEventListener('click', () => { theoryModal.classList.remove('hidden'); speakMessage("Detailed theory modal opened."); });
        document.getElementById('theory-modal-close-btn').addEventListener('click', () => theoryModal.classList.add('hidden'));

        const darkModeToggle = document.getElementById('dark-mode-toggle');
        darkModeToggle.addEventListener('change', () => {
            isDarkMode = darkModeToggle.checked; document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('reflectionSimDarkMode', isDarkMode);
            if (currentStep === 6 && currentSimulationResults.Gamma) renderStandingWavePattern(currentSimulationResults); 
            if (document.getElementById('analyticsTab').classList.contains('active')) renderAnalyticsCharts();
            speakMessage(isDarkMode ? "Dark mode enabled." : "Dark mode disabled.");
        });

        document.getElementById('voice-toggle-btn').addEventListener('click', toggleVoiceInstructions);
        document.getElementById('print-btn').addEventListener('click', () => window.print());
        document.getElementById('screenshot-btn').addEventListener('click', () => {
            const activeTabPanel = document.querySelector('.tab-panel.active') || document.body;
            showLoadingOverlay();
            html2canvas(activeTabPanel, { scale: 1.5, useCORS: true, backgroundColor: isDarkMode ? '#1a202c' : '#f3f4f6', logging: false })
                .then(canvas => {
                    const link = document.createElement('a'); link.download = `reflection_sim_screenshot_${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL(); link.click(); hideLoadingOverlay(); speakMessage("Screenshot captured.");
                }).catch(err => { console.error("Screenshot failed:", err); showCustomAlert("Could not take screenshot."); hideLoadingOverlay(); });
        });

        window.addEventListener('resize', () => {
            if (currentStep === 6 && currentSimulationResults.Gamma && document.getElementById('simulationTab').classList.contains('active')) {
                 setTimeout(() => renderStandingWavePattern(currentSimulationResults), 100);
            }
            if (document.getElementById('analyticsTab').classList.contains('active') && experimentHistory.length > 0) {
                setTimeout(renderAnalyticsCharts, 100);
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('reflectionSimDarkMode') === 'true') {
                darkModeToggle.checked = true; isDarkMode = true; document.documentElement.classList.add('dark');
            }
            if (localStorage.getItem('reflectionSimVoiceEnabled') === 'true') {
                isVoiceEnabled = true; document.getElementById('voice-on-icon').classList.remove('hidden'); document.getElementById('voice-off-icon').classList.add('hidden');
            } else { isVoiceEnabled = false; document.getElementById('voice-on-icon').classList.add('hidden'); document.getElementById('voice-off-icon').classList.remove('hidden'); }

            loadDefaultParameters(); updateStepUI(); loadHistory(); 
        });
    </script>
</body>
</html>